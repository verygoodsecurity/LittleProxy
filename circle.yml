---
machine:
  java:
    version: oraclejdk8
  environment:
    AWS_PROFILE: vgs-dev
    RELEASE_BRANCH: versioning-test
dependencies:
  override:
    - ./env.sh
    - mvn clean dependency:go-offline install -Dmaven.test.skip=true --fail-never --threads 5 -B
test:
  override:
    - mvn test -T2 -DskipTests
deployment:
  snapshot:
    branch: vgs-edition
    owner: verygoodsecurity
    commands:
      - mvn deploy -DskipTests=true
  release:
      branch: /.*/
      commands:
        - git config user.name "circleci"
        - git fetch
        - git checkout $RELEASE_BRANCH
        - git pull origin $RELEASE_BRANCH
        - git reset --hard
        - git tag -d $CIRCLE_TAG
        - mvn -B -X -e gitflow:release-start gitflow:release-finish -DreleaseVersion=$CIRCLE_TAG -DpostReleaseGoals=deploy -DskipTests
        - git push origin $RELEASE_BRANCH
