---
machine:
  java:
    version: oraclejdk8
  environment:
    AWS_PROFILE: vgs-dev
    RELEASE_BRANCH: versioning-test
dependencies:
  override:
    - ./env.sh
    - mvn clean dependency:go-offline install -Dmaven.test.skip=true --fail-never --threads 5 -B
test:
  override:
    - mvn test -T2 -DskipTests
deployment:
  snapshot:
    branch: vgs-edition
    owner: verygoodsecurity
    commands:
      - mvn deploy -DskipTests=true
  release:
      branch: /.*/
      commands:
        - git config user.name "circleci"
        - git fetch
        - git checkout $RELEASE_BRANCH
        - git tag -d $CIRCLE_TAG
        - mvn -B -X -e com.amashchenko.maven.plugin:gitflow-maven-plugin:release-start com.amashchenko.maven.plugin:gitflow-maven-plugin:release-finish \
            -DreleaseVersion=$CIRCLE_TAG \
            -Dverbose=true -DversionDigitToIncrement=2 -DreleaseRebase=true -DpushRemote=false -DskipTestProject=true -DallowSnapshots=true \
            -DgitFlowConfig.productionBranch=versioning-test -DgitFlowConfig.developmentBranch=versioning-test \
            -DgitFlowConfig.releaseBranchPrefix=release- -DgitFlowConfig.versionTagPrefix='' \
            -DcommitMessages.releaseStartMessage='update versions for @{version} release' \
            -DcommitMessages.releaseFinishMessage='update for next development version @{version}' 
